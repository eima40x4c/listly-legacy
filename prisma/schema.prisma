// Listly Database Schema
// Generated for SOP-101: Schema Design
// Date: 2026-02-09
// Prisma Version: 5.22.0

generator client {
  provider = "prisma-client-js"
}

// Note: For Prisma 7+, datasource URL configuration will move to prisma.config.ts
// Current setup is compatible with Prisma 5.x (staying on v5 for stability)
datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

// ============================================
// Authentication & Users
// ============================================

model User {
  id            String       @id @default(cuid())
  email         String       @unique
  name          String
  passwordHash  String?      @map("password_hash") // Nullable for OAuth-only users
  avatarUrl     String?      @map("avatar_url")
  provider      AuthProvider @default(EMAIL)
  providerId    String?      @map("provider_id") // OAuth provider user ID
  emailVerified Boolean      @default(false) @map("email_verified")
  isActive      Boolean      @default(true) @map("is_active")
  createdAt     DateTime     @default(now()) @map("created_at")
  updatedAt     DateTime     @updatedAt @map("updated_at")

  // Relations
  ownedLists     ShoppingList[]      @relation("ListOwner")
  collaborations ListCollaborator[]
  addedItems     ListItem[]
  pantryItems    PantryItem[]
  recipes        Recipe[]
  mealPlans      MealPlan[]
  itemHistory    ItemHistory[]
  preferences    UserPreferences?
  favoriteStores UserFavoriteStore[]
  accounts       Account[]
  sessions       Session[]

  @@index([email])
  @@index([provider, providerId])
  @@map("users")
}

enum AuthProvider {
  EMAIL
  GOOGLE
  APPLE
}

model UserPreferences {
  id                   String   @id @default(cuid())
  defaultBudgetWarning Decimal? @map("default_budget_warning") @db.Decimal(10, 2)
  defaultCurrency      String   @default("USD") @map("default_currency")
  notificationsEnabled Boolean  @default(true) @map("notifications_enabled")
  locationReminders    Boolean  @default(false) @map("location_reminders")
  theme                String   @default("system") // "light", "dark", "system"
  createdAt            DateTime @default(now()) @map("created_at")
  updatedAt            DateTime @updatedAt @map("updated_at")

  // Relations
  userId String @unique @map("user_id")
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("user_preferences")
}

// ============================================
// NextAuth.js Models
// ============================================

model Account {
  id                String  @id @default(cuid())
  userId            String  @map("user_id")
  type              String
  provider          String
  providerAccountId String  @map("provider_account_id")
  refresh_token     String? @db.Text
  access_token      String? @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.Text
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@index([userId])
  @@map("accounts")
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique @map("session_token")
  userId       String   @map("user_id")
  expires      DateTime

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("sessions")
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
  @@map("verification_tokens")
}

// ============================================
// Shopping Lists & Items
// ============================================

model ShoppingList {
  id          String     @id @default(cuid())
  name        String
  description String?
  budget      Decimal?   @db.Decimal(10, 2)
  status      ListStatus @default(ACTIVE)
  isTemplate  Boolean    @default(false) @map("is_template")
  color       String? // Hex color for UI
  icon        String? // Icon identifier
  createdAt   DateTime   @default(now()) @map("created_at")
  updatedAt   DateTime   @updatedAt @map("updated_at")
  completedAt DateTime?  @map("completed_at")

  // Relations
  ownerId       String             @map("owner_id")
  owner         User               @relation("ListOwner", fields: [ownerId], references: [id], onDelete: Cascade)
  storeId       String?            @map("store_id")
  store         Store?             @relation(fields: [storeId], references: [id], onDelete: SetNull)
  items         ListItem[]
  collaborators ListCollaborator[]

  @@index([ownerId])
  @@index([status])
  @@index([storeId])
  @@index([createdAt])
  @@map("shopping_lists")
}

enum ListStatus {
  ACTIVE
  COMPLETED
  ARCHIVED
}

model ListItem {
  id             String    @id @default(cuid())
  name           String
  quantity       Decimal   @default(1) @db.Decimal(10, 2)
  unit           String? // "kg", "lbs", "pcs", etc.
  notes          String?
  isChecked      Boolean   @default(false) @map("is_checked")
  priority       Int       @default(0) // Higher = more important
  estimatedPrice Decimal?  @map("estimated_price") @db.Decimal(10, 2)
  sortOrder      Int       @default(0) @map("sort_order")
  createdAt      DateTime  @default(now()) @map("created_at")
  updatedAt      DateTime  @updatedAt @map("updated_at")
  checkedAt      DateTime? @map("checked_at")

  // Relations
  listId     String        @map("list_id")
  list       ShoppingList  @relation(fields: [listId], references: [id], onDelete: Cascade)
  categoryId String?       @map("category_id")
  category   Category?     @relation(fields: [categoryId], references: [id], onDelete: SetNull)
  addedById  String        @map("added_by_id")
  addedBy    User          @relation(fields: [addedById], references: [id])
  history    ItemHistory[]

  @@index([listId])
  @@index([categoryId])
  @@index([isChecked])
  @@index([listId, sortOrder])
  @@map("list_items")
}

model ListCollaborator {
  id       String           @id @default(cuid())
  role     CollaboratorRole @default(EDITOR)
  joinedAt DateTime         @default(now()) @map("joined_at")

  // Relations
  listId String       @map("list_id")
  list   ShoppingList @relation(fields: [listId], references: [id], onDelete: Cascade)
  userId String       @map("user_id")
  user   User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([listId, userId])
  @@index([userId])
  @@index([listId])
  @@map("list_collaborators")
}

enum CollaboratorRole {
  VIEWER
  EDITOR
  ADMIN
}

// ============================================
// Categories & Organization
// ============================================

model Category {
  id          String   @id @default(cuid())
  name        String
  slug        String   @unique
  description String?
  icon        String?
  color       String?
  isDefault   Boolean  @default(false) @map("is_default")
  sortOrder   Int      @default(0) @map("sort_order")
  createdAt   DateTime @default(now()) @map("created_at")

  // Relations
  listItems       ListItem[]
  pantryItems     PantryItem[]
  storeCategories StoreCategory[]

  @@index([slug])
  @@index([sortOrder])
  @@map("categories")
}

// ============================================
// Stores & Locations
// ============================================

model Store {
  id        String   @id @default(cuid())
  name      String
  chain     String? // "Whole Foods", "Costco", etc.
  address   String?
  latitude  Decimal? @db.Decimal(10, 8)
  longitude Decimal? @db.Decimal(11, 8)
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  shoppingLists ShoppingList[]
  categories    StoreCategory[]
  favoriteUsers UserFavoriteStore[]
  itemHistory   ItemHistory[]

  @@index([latitude, longitude])
  @@map("stores")
}

model StoreCategory {
  id          String  @id @default(cuid())
  aisleNumber String? @map("aisle_number")
  customName  String? @map("custom_name")
  sortOrder   Int     @default(0) @map("sort_order")

  // Relations
  storeId    String   @map("store_id")
  store      Store    @relation(fields: [storeId], references: [id], onDelete: Cascade)
  categoryId String   @map("category_id")
  category   Category @relation(fields: [categoryId], references: [id], onDelete: Cascade)

  @@unique([storeId, categoryId])
  @@index([storeId])
  @@map("store_categories")
}

model UserFavoriteStore {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now()) @map("created_at")

  // Relations
  userId  String @map("user_id")
  user    User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  storeId String @map("store_id")
  store   Store  @relation(fields: [storeId], references: [id], onDelete: Cascade)

  @@unique([userId, storeId])
  @@index([userId])
  @@map("user_favorite_stores")
}

// ============================================
// Item History & Price Tracking
// ============================================

model ItemHistory {
  id        String     @id @default(cuid())
  itemName  String     @map("item_name") // Denormalized for history
  quantity  Decimal    @db.Decimal(10, 2)
  unit      String?
  price     Decimal?   @db.Decimal(10, 2)
  action    ItemAction
  createdAt DateTime   @default(now()) @map("created_at")

  // Relations
  itemId  String?   @map("item_id") // Nullable in case item is deleted
  item    ListItem? @relation(fields: [itemId], references: [id], onDelete: SetNull)
  userId  String    @map("user_id")
  user    User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  storeId String?   @map("store_id")
  store   Store?    @relation(fields: [storeId], references: [id], onDelete: SetNull)

  @@index([itemId])
  @@index([userId])
  @@index([itemName])
  @@index([storeId, itemName, createdAt])
  @@map("item_history")
}

enum ItemAction {
  ADDED
  CHECKED
  UNCHECKED
  REMOVED
  PRICE_UPDATED
}

// ============================================
// Pantry & Inventory
// ============================================

model PantryItem {
  id             String    @id @default(cuid())
  name           String
  quantity       Decimal   @db.Decimal(10, 2)
  unit           String?
  location       String? // "fridge", "freezer", "pantry", "cabinet"
  barcode        String?
  expirationDate DateTime? @map("expiration_date")
  purchaseDate   DateTime? @map("purchase_date")
  purchasePrice  Decimal?  @map("purchase_price") @db.Decimal(10, 2)
  notes          String?
  isConsumed     Boolean   @default(false) @map("is_consumed")
  createdAt      DateTime  @default(now()) @map("created_at")
  updatedAt      DateTime  @updatedAt @map("updated_at")

  // Relations
  userId     String    @map("user_id")
  user       User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  categoryId String?   @map("category_id")
  category   Category? @relation(fields: [categoryId], references: [id], onDelete: SetNull)

  @@index([userId])
  @@index([categoryId])
  @@index([expirationDate])
  @@index([barcode])
  @@index([location])
  @@map("pantry_items")
}

// ============================================
// Recipes & Meal Planning
// ============================================

model Recipe {
  id           String   @id @default(cuid())
  title        String
  description  String?
  instructions String   @db.Text
  prepTime     Int?     @map("prep_time") // minutes
  cookTime     Int?     @map("cook_time") // minutes
  servings     Int?
  difficulty   String? // "easy", "medium", "hard"
  cuisine      String?
  imageUrl     String?  @map("image_url")
  sourceUrl    String?  @map("source_url")
  isPublic     Boolean  @default(false) @map("is_public")
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  // Relations
  userId      String             @map("user_id")
  user        User               @relation(fields: [userId], references: [id], onDelete: Cascade)
  ingredients RecipeIngredient[]
  mealPlans   MealPlan[]

  @@index([userId])
  @@index([cuisine])
  @@map("recipes")
}

model RecipeIngredient {
  id        String  @id @default(cuid())
  name      String
  quantity  Decimal @db.Decimal(10, 2)
  unit      String?
  notes     String?
  sortOrder Int     @default(0) @map("sort_order")

  // Relations
  recipeId String @map("recipe_id")
  recipe   Recipe @relation(fields: [recipeId], references: [id], onDelete: Cascade)

  @@index([recipeId])
  @@map("recipe_ingredients")
}

model MealPlan {
  id          String   @id @default(cuid())
  mealType    MealType @map("meal_type")
  date        DateTime // Scheduled date
  notes       String?
  isCompleted Boolean  @default(false) @map("is_completed")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  // Relations
  userId   String  @map("user_id")
  user     User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  recipeId String? @map("recipe_id")
  recipe   Recipe? @relation(fields: [recipeId], references: [id], onDelete: SetNull)

  @@index([userId])
  @@index([date])
  @@index([userId, date])
  @@map("meal_plans")
}

enum MealType {
  BREAKFAST
  LUNCH
  DINNER
  SNACK
}
